<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Savvy Realty | VA Training Assessment</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --sky:#4ABDE8; --sky-light:#D6F0FA; --sky-dark:#2896C8;
    --black:#0F1114; --gray-dark:#2C3039; --gray-mid:#6B7280;
    --gray-light:#E8EDF2; --white:#FFFFFF;
    --green:#22C55E; --red:#EF4444; --gold:#F59E0B;
    --radius:12px; --shadow:0 4px 24px rgba(15,17,20,0.10);
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'DM Sans',sans-serif;background:#F0F6FA;color:var(--black);min-height:100vh;}

  /* HEADER */
  .site-header{background:var(--black);padding:0 40px;display:flex;align-items:center;
    justify-content:space-between;height:64px;position:sticky;top:0;z-index:100;
    box-shadow:0 2px 12px rgba(0,0,0,0.3);}
  .logo{font-family:'DM Serif Display',serif;font-size:22px;color:var(--white);}
  .logo span{color:var(--sky);}
  .header-right{display:flex;align-items:center;gap:12px;}
  .header-badge{font-size:12px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;
    color:var(--sky);border:1px solid var(--sky-dark);border-radius:20px;padding:4px 14px;}
  .admin-link{font-size:12px;font-weight:600;color:rgba(255,255,255,0.4);background:none;border:none;
    cursor:pointer;font-family:'DM Sans',sans-serif;letter-spacing:0.04em;transition:color .2s;padding:4px 8px;}
  .admin-link:hover{color:var(--sky);}

  /* SETUP BANNER ‚Äî shown when script URL not configured */
  .setup-banner{background:#FEF3C7;border-bottom:2px solid var(--gold);padding:14px 40px;
    display:flex;align-items:center;gap:14px;font-size:14px;color:#92400E;}
  .setup-banner strong{font-weight:700;}
  .setup-banner a{color:var(--sky-dark);font-weight:600;cursor:pointer;text-decoration:underline;}
  .setup-banner .icon{font-size:20px;flex-shrink:0;}

  /* WRAPPER */
  .wrapper{max-width:820px;margin:0 auto;padding:40px 20px 80px;}

  /* SCREENS */
  .screen{display:none;}
  .screen.active{display:block;animation:fadeSlide .4s ease both;}
  @keyframes fadeSlide{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:none;}}

  /* INTRO */
  .intro-hero{background:var(--black);border-radius:20px;padding:56px 48px;color:var(--white);
    margin-bottom:28px;position:relative;overflow:hidden;}
  .intro-hero::before{content:'';position:absolute;top:-60px;right:-60px;width:260px;height:260px;
    border-radius:50%;background:radial-gradient(circle,rgba(74,189,232,0.18),transparent 70%);}
  .intro-hero h1{font-family:'DM Serif Display',serif;font-size:36px;line-height:1.2;margin-bottom:16px;}
  .intro-hero h1 em{color:var(--sky);font-style:normal;}
  .intro-hero p{font-size:16px;color:rgba(255,255,255,0.72);line-height:1.7;max-width:520px;margin-bottom:32px;}
  .intro-meta{display:flex;gap:16px;flex-wrap:wrap;}
  .meta-chip{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.08);
    border:1px solid rgba(255,255,255,0.14);border-radius:8px;padding:10px 16px;font-size:13px;font-weight:500;}

  .name-card{background:var(--white);border-radius:var(--radius);padding:32px 36px;box-shadow:var(--shadow);margin-bottom:24px;}
  .name-card label{display:block;font-weight:600;font-size:13px;text-transform:uppercase;
    letter-spacing:0.06em;color:var(--gray-mid);margin-bottom:10px;}
  .field-input{width:100%;border:2px solid var(--gray-light);border-radius:8px;padding:14px 16px;
    font-size:16px;font-family:'DM Sans',sans-serif;transition:border-color .2s;outline:none;}
  .field-input:focus{border-color:var(--sky);}

  /* PROGRESS */
  .progress-bar-wrap{background:var(--white);border-radius:100px;height:6px;margin-bottom:28px;overflow:hidden;}
  .progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--sky-dark),var(--sky));border-radius:100px;transition:width .5s cubic-bezier(.4,0,.2,1);}
  .progress-label{display:flex;justify-content:space-between;font-size:13px;color:var(--gray-mid);margin-bottom:12px;}

  /* SECTION DIVIDER */
  .section-divider{display:flex;align-items:center;gap:14px;margin:36px 0 20px;}
  .section-divider-label{background:var(--black);color:var(--white);font-size:11px;font-weight:700;
    letter-spacing:0.1em;text-transform:uppercase;padding:5px 14px;border-radius:20px;white-space:nowrap;}
  .section-divider-label.accent{background:var(--sky-dark);}
  .section-divider-line{flex:1;height:1px;background:var(--gray-light);}

  /* QUESTION CARD */
  .q-card{background:var(--white);border-radius:var(--radius);padding:28px 32px;margin-bottom:18px;
    box-shadow:var(--shadow);border:2px solid transparent;transition:border-color .2s;}
  .q-card.answered{border-color:var(--sky-light);}
  .q-card.correct{border-color:#BBF7D0;background:#F0FDF4;}
  .q-card.incorrect{border-color:#FECACA;background:#FFF5F5;}
  .q-number{font-size:11px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--sky-dark);margin-bottom:10px;}
  .q-text{font-size:16px;font-weight:500;line-height:1.6;color:var(--black);margin-bottom:20px;}
  .q-text .highlight{background:var(--sky-light);border-radius:4px;padding:1px 6px;}

  /* MC */
  .options-grid{display:flex;flex-direction:column;gap:10px;}
  .option-btn{display:flex;align-items:center;gap:14px;padding:14px 18px;border:2px solid var(--gray-light);
    border-radius:10px;background:var(--white);cursor:pointer;font-family:'DM Sans',sans-serif;
    font-size:15px;text-align:left;transition:all .18s;}
  .option-btn:hover:not(:disabled){border-color:var(--sky);background:var(--sky-light);}
  .option-btn.selected{border-color:var(--sky-dark);background:var(--sky-light);font-weight:600;}
  .option-btn.correct-ans{border-color:var(--green);background:#F0FDF4;color:#15803D;font-weight:600;}
  .option-btn.wrong-ans{border-color:var(--red);background:#FFF5F5;color:#B91C1C;text-decoration:line-through;}
  .option-btn:disabled{cursor:default;}
  .option-letter{width:30px;height:30px;border-radius:50%;background:var(--gray-light);display:flex;
    align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;transition:background .18s;}
  .option-btn.selected .option-letter{background:var(--sky-dark);color:white;}
  .option-btn.correct-ans .option-letter{background:var(--green);color:white;}
  .option-btn.wrong-ans .option-letter{background:var(--red);color:white;}

  /* T/F */
  .tf-grid{display:flex;gap:12px;}
  .tf-btn{flex:1;padding:16px;border:2px solid var(--gray-light);border-radius:10px;background:var(--white);
    cursor:pointer;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;transition:all .18s;text-align:center;}
  .tf-btn:hover:not(:disabled){border-color:var(--sky);background:var(--sky-light);}
  .tf-btn.selected{border-color:var(--sky-dark);background:var(--sky-light);color:var(--sky-dark);}
  .tf-btn.correct-ans{border-color:var(--green);background:#F0FDF4;color:#15803D;}
  .tf-btn.wrong-ans{border-color:var(--red);background:#FFF5F5;color:#B91C1C;}
  .tf-btn:disabled{cursor:default;}

  /* FILL */
  .fill-input{width:100%;border:2px solid var(--gray-light);border-radius:10px;padding:14px 16px;
    font-size:15px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color .2s;}
  .fill-input:focus{border-color:var(--sky);}
  .fill-input.correct{border-color:var(--green);background:#F0FDF4;}
  .fill-input.incorrect{border-color:var(--red);background:#FFF5F5;}

  /* WRITTEN */
  .written-area{width:100%;border:2px solid var(--gray-light);border-radius:10px;padding:14px 16px;
    font-size:15px;font-family:'DM Sans',sans-serif;min-height:120px;resize:vertical;outline:none;
    transition:border-color .2s;line-height:1.6;}
  .written-area:focus{border-color:var(--sky);}
  .written-label{font-size:12px;color:var(--sky-dark);font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:6px;}
  .badge-manual{background:var(--sky-light);color:var(--sky-dark);font-size:11px;font-weight:700;
    letter-spacing:0.06em;text-transform:uppercase;border-radius:20px;padding:2px 10px;}

  /* FEEDBACK */
  .q-feedback{margin-top:14px;padding:12px 16px;border-radius:8px;font-size:14px;line-height:1.6;display:none;}
  .q-feedback.show{display:block;}
  .q-feedback.correct-fb{background:#DCFCE7;color:#166534;border-left:4px solid var(--green);}
  .q-feedback.incorrect-fb{background:#FEE2E2;color:#991B1B;border-left:4px solid var(--red);}

  /* BUTTONS */
  .check-btn{margin-top:16px;padding:11px 24px;background:var(--sky-dark);color:white;border:none;
    border-radius:8px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:background .2s,transform .1s;}
  .check-btn:hover{background:#1e7dab;}
  .check-btn:active{transform:scale(0.97);}
  .check-btn:disabled{background:var(--gray-mid);cursor:default;}
  .submit-btn{width:100%;padding:18px;background:linear-gradient(135deg,var(--sky-dark),var(--sky));
    color:white;border:none;border-radius:12px;font-family:'DM Sans',sans-serif;font-size:17px;
    font-weight:700;cursor:pointer;transition:opacity .2s,transform .1s;
    box-shadow:0 4px 20px rgba(74,189,232,0.35);margin-top:32px;letter-spacing:0.02em;}
  .submit-btn:hover{opacity:0.92;}
  .submit-btn:active{transform:scale(0.98);}
  .btn-primary{padding:14px 32px;background:var(--black);color:white;border:none;border-radius:10px;
    font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:background .2s;}
  .btn-primary:hover{background:var(--gray-dark);}

  /* RESULTS */
  .result-hero{background:var(--black);border-radius:20px;padding:48px;color:white;margin-bottom:28px;
    text-align:center;position:relative;overflow:hidden;}
  .result-hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 0%,rgba(74,189,232,0.2) 0%,transparent 70%);}
  .score-ring{width:140px;height:140px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    margin:0 auto 24px;position:relative;z-index:1;}
  .score-inner{width:110px;height:110px;border-radius:50%;background:var(--black);display:flex;
    flex-direction:column;align-items:center;justify-content:center;}
  .score-pct{font-family:'DM Serif Display',serif;font-size:34px;color:white;line-height:1;}
  .score-sub{font-size:12px;color:rgba(255,255,255,0.5);}
  .result-hero h2{font-family:'DM Serif Display',serif;font-size:28px;margin-bottom:10px;position:relative;z-index:1;}
  .result-hero p{color:rgba(255,255,255,0.65);font-size:15px;position:relative;z-index:1;}

  .stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:28px;}
  .stat-card{background:var(--white);border-radius:var(--radius);padding:20px;text-align:center;box-shadow:var(--shadow);}
  .stat-card .val{font-family:'DM Serif Display',serif;font-size:32px;line-height:1;margin-bottom:6px;}
  .stat-card .lbl{font-size:13px;color:var(--gray-mid);font-weight:500;}
  .stat-card.green .val{color:var(--green);}
  .stat-card.red .val{color:var(--red);}
  .stat-card.gold .val{color:var(--gold);}

  /* GRADING */
  .grading-section{background:var(--white);border-radius:var(--radius);padding:28px 32px;box-shadow:var(--shadow);margin-bottom:24px;}
  .grading-section h3{font-family:'DM Serif Display',serif;font-size:20px;margin-bottom:6px;}
  .grading-section .sub{font-size:14px;color:var(--gray-mid);margin-bottom:24px;}
  .manual-q{border:1px solid var(--gray-light);border-radius:10px;padding:20px;margin-bottom:16px;}
  .manual-q-label{font-size:13px;font-weight:700;color:var(--sky-dark);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;}
  .manual-q-text{font-size:15px;font-weight:500;color:var(--black);margin-bottom:12px;line-height:1.5;}
  .manual-q-response{background:#F8FAFC;border-radius:8px;padding:14px;font-size:14px;color:var(--gray-dark);
    line-height:1.7;margin-bottom:14px;min-height:50px;font-style:italic;}
  .grade-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  .grade-label{font-size:13px;font-weight:600;color:var(--gray-mid);margin-right:4px;}
  .grade-btn{padding:7px 18px;border-radius:8px;border:2px solid transparent;
    font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;}
  .grade-btn.pass{border-color:var(--green);color:#15803D;background:transparent;}
  .grade-btn.pass:hover,.grade-btn.pass.active{background:var(--green);color:white;}
  .grade-btn.fail{border-color:var(--red);color:#B91C1C;background:transparent;}
  .grade-btn.fail:hover,.grade-btn.fail.active{background:var(--red);color:white;}
  .grade-btn.partial{border-color:var(--gold);color:#92400E;background:transparent;}
  .grade-btn.partial:hover,.grade-btn.partial.active{background:var(--gold);color:white;}
  .grade-note-input{width:100%;margin-top:10px;border:1px solid var(--gray-light);border-radius:8px;
    padding:10px 14px;font-size:13px;font-family:'DM Sans',sans-serif;color:var(--gray-dark);outline:none;transition:border-color .2s;}
  .grade-note-input:focus{border-color:var(--sky);}
  .final-score-btn{width:100%;padding:16px;background:var(--black);color:white;border:none;
    border-radius:10px;font-family:'DM Sans',sans-serif;font-size:16px;font-weight:700;cursor:pointer;transition:background .2s;margin-top:8px;}
  .final-score-btn:hover{background:var(--gray-dark);}
  .final-score-display{background:linear-gradient(135deg,var(--sky-dark),var(--sky));color:white;border-radius:12px;
    padding:24px 32px;text-align:center;margin-top:16px;display:none;}
  .final-score-display.show{display:block;animation:fadeSlide .4s ease both;}
  .final-score-display .big{font-family:'DM Serif Display',serif;font-size:44px;}
  .final-score-display .detail{font-size:15px;opacity:0.85;margin-top:8px;}

  /* SAVE / SYNC BUTTON */
  .save-results-btn{width:100%;padding:16px;border:none;border-radius:10px;
    font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;cursor:pointer;
    transition:all .2s;margin-top:12px;display:flex;align-items:center;justify-content:center;gap:8px;}
  .save-results-btn.idle{background:var(--sky-dark);color:white;}
  .save-results-btn.idle:hover{background:#1e7dab;}
  .save-results-btn.saving{background:var(--gray-mid);color:white;cursor:default;}
  .save-results-btn.saved{background:var(--green);color:white;cursor:default;}
  .save-results-btn.error{background:var(--red);color:white;}
  .print-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:11px 22px;
    border:2px solid var(--gray-light);border-radius:10px;background:transparent;
    font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;color:var(--gray-mid);
    cursor:pointer;transition:all .2s;margin-top:12px;width:100%;}
  .print-btn:hover{border-color:var(--sky);color:var(--sky-dark);}

  /* INFO BOX */
  .info-box{background:var(--sky-light);border-radius:var(--radius);padding:18px 24px;font-size:14px;
    color:var(--sky-dark);border:1px solid rgba(74,189,232,0.25);margin-bottom:24px;}

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ADMIN LOGIN
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .admin-login-wrap{max-width:420px;margin:80px auto;padding:20px;}
  .admin-login-card{background:var(--white);border-radius:20px;padding:48px 40px;
    box-shadow:0 8px 40px rgba(15,17,20,0.14);text-align:center;}
  .admin-lock{font-size:48px;margin-bottom:20px;}
  .admin-login-card h2{font-family:'DM Serif Display',serif;font-size:26px;margin-bottom:8px;}
  .admin-login-card p{font-size:14px;color:var(--gray-mid);margin-bottom:32px;}
  .admin-pw-input{width:100%;border:2px solid var(--gray-light);border-radius:10px;padding:14px 18px;
    font-size:16px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color .2s;
    text-align:center;letter-spacing:0.1em;margin-bottom:14px;}
  .admin-pw-input:focus{border-color:var(--sky);}
  .admin-pw-input.error{border-color:var(--red);background:#FFF5F5;animation:shake .3s ease;}
  @keyframes shake{0%,100%{transform:translateX(0);}20%,60%{transform:translateX(-6px);}40%,80%{transform:translateX(6px);}}
  .admin-login-btn{width:100%;padding:14px;background:var(--black);color:white;border:none;
    border-radius:10px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:background .2s;}
  .admin-login-btn:hover{background:var(--gray-dark);}
  .admin-error{color:var(--red);font-size:13px;margin-top:10px;min-height:18px;}
  .admin-back{margin-top:20px;font-size:13px;color:var(--gray-mid);cursor:pointer;background:none;border:none;font-family:'DM Sans',sans-serif;}
  .admin-back:hover{color:var(--sky-dark);}

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ADMIN DASHBOARD
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .admin-header-bar{background:var(--black);border-radius:20px;padding:36px 40px;color:white;
    margin-bottom:28px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;}
  .admin-header-bar h1{font-family:'DM Serif Display',serif;font-size:28px;}
  .admin-header-bar p{color:rgba(255,255,255,0.55);font-size:14px;margin-top:4px;}
  .admin-header-right{display:flex;gap:10px;align-items:center;}
  .admin-logout-btn{padding:9px 20px;border:1px solid rgba(255,255,255,0.2);border-radius:8px;
    background:transparent;color:rgba(255,255,255,0.6);font-family:'DM Sans',sans-serif;
    font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
  .admin-logout-btn:hover{border-color:var(--sky);color:var(--sky);}
  .admin-refresh-btn{padding:9px 16px;border:1px solid rgba(74,189,232,0.4);border-radius:8px;
    background:transparent;color:var(--sky);font-family:'DM Sans',sans-serif;
    font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
  .admin-refresh-btn:hover{background:rgba(74,189,232,0.1);}
  .admin-refresh-btn.spinning{opacity:0.5;cursor:default;}

  .admin-summary-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:28px;}
  .admin-stat{background:var(--white);border-radius:var(--radius);padding:18px 20px;box-shadow:var(--shadow);}
  .admin-stat .av{font-family:'DM Serif Display',serif;font-size:28px;color:var(--black);line-height:1;}
  .admin-stat .al{font-size:12px;color:var(--gray-mid);font-weight:600;text-transform:uppercase;letter-spacing:0.05em;margin-top:4px;}
  .admin-stat.sky .av{color:var(--sky-dark);}
  .admin-stat.grn .av{color:var(--green);}
  .admin-stat.gold .av{color:var(--gold);}

  /* sync status badge in dashboard */
  .sync-status{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:600;
    padding:5px 12px;border-radius:20px;margin-bottom:20px;}
  .sync-status.connected{background:#DCFCE7;color:#166534;}
  .sync-status.disconnected{background:#FEE2E2;color:#991B1B;}
  .sync-status.loading{background:var(--sky-light);color:var(--sky-dark);}

  .submissions-card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:24px;}
  .submissions-card-header{padding:20px 28px;border-bottom:1px solid var(--gray-light);
    display:flex;align-items:center;justify-content:space-between;}
  .submissions-card-header h3{font-family:'DM Serif Display',serif;font-size:18px;}

  .no-submissions{padding:48px;text-align:center;color:var(--gray-mid);font-size:15px;}
  .no-submissions .icon{font-size:40px;margin-bottom:12px;}

  .submission-row{padding:20px 28px;border-bottom:1px solid var(--gray-light);cursor:pointer;
    transition:background .15s;display:flex;align-items:center;gap:16px;justify-content:space-between;}
  .submission-row:last-child{border-bottom:none;}
  .submission-row:hover{background:#F8FAFC;}
  .sub-name{font-weight:600;font-size:15px;color:var(--black);}
  .sub-date{font-size:12px;color:var(--gray-mid);margin-top:2px;}
  .sub-scores{display:flex;align-items:center;gap:10px;flex-shrink:0;}
  .score-pill{padding:5px 12px;border-radius:20px;font-size:13px;font-weight:700;white-space:nowrap;}
  .score-pill.high{background:#DCFCE7;color:#15803D;}
  .score-pill.mid{background:#FEF9C3;color:#854D0E;}
  .score-pill.low{background:#FEE2E2;color:#991B1B;}
  .score-pill.pending{background:var(--sky-light);color:var(--sky-dark);}
  .expand-icon{color:var(--gray-mid);font-size:18px;transition:transform .2s;}
  .submission-row.open .expand-icon{transform:rotate(180deg);}

  /* DETAIL PANEL */
  .submission-detail{display:none;padding:0 28px 28px;border-bottom:1px solid var(--gray-light);background:#FAFCFE;}
  .submission-detail.open{display:block;animation:fadeSlide .25s ease both;}
  .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;margin-top:4px;}
  .detail-stat{background:var(--white);border-radius:10px;padding:14px 16px;border:1px solid var(--gray-light);}
  .detail-stat .dv{font-family:'DM Serif Display',serif;font-size:22px;color:var(--black);}
  .detail-stat .dl{font-size:12px;color:var(--gray-mid);margin-top:2px;}
  .detail-section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--gray-mid);margin:20px 0 10px;}
  .answer-list{display:flex;flex-direction:column;gap:8px;}
  .answer-item{display:flex;align-items:flex-start;gap:10px;padding:10px 14px;border-radius:8px;font-size:13px;line-height:1.5;}
  .answer-item.corr{background:#F0FDF4;border:1px solid #BBF7D0;}
  .answer-item.incr{background:#FFF5F5;border:1px solid #FECACA;}
  .answer-item.skip{background:var(--gray-light);border:1px solid var(--gray-light);}
  .answer-icon{font-size:14px;flex-shrink:0;margin-top:1px;}
  .answer-qtext{font-weight:500;color:var(--black);}
  .answer-given{color:var(--gray-mid);font-size:12px;margin-top:2px;}

  .admin-written-q{background:var(--white);border:1px solid var(--gray-light);border-radius:10px;padding:18px;margin-bottom:12px;}
  .admin-wq-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--sky-dark);margin-bottom:8px;}
  .admin-wq-text{font-size:14px;font-weight:500;color:var(--black);margin-bottom:10px;line-height:1.5;}
  .admin-wq-resp{background:#F8FAFC;border-radius:8px;padding:12px;font-size:13px;color:var(--gray-dark);
    line-height:1.7;margin-bottom:12px;font-style:italic;min-height:36px;}
  .admin-grade-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .admin-grade-note{width:100%;margin-top:8px;border:1px solid var(--gray-light);border-radius:8px;
    padding:9px 12px;font-size:13px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color .2s;}
  .admin-grade-note:focus{border-color:var(--sky);}
  .admin-save-grades-btn{margin-top:14px;padding:10px 24px;background:var(--sky-dark);color:white;border:none;
    border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:background .2s;}
  .admin-save-grades-btn:hover{background:#1e7dab;}
  .admin-save-grades-btn.saved{background:var(--green);}
  .detail-guidance{background:var(--sky-light);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--sky-dark);line-height:1.6;margin-bottom:10px;}

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SETUP GUIDE SCREEN
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .setup-card{background:var(--white);border-radius:20px;padding:48px;box-shadow:var(--shadow);margin-bottom:24px;}
  .setup-card h2{font-family:'DM Serif Display',serif;font-size:28px;margin-bottom:8px;}
  .setup-card .lead{font-size:16px;color:var(--gray-mid);margin-bottom:36px;line-height:1.6;}
  .setup-steps{display:flex;flex-direction:column;gap:0;}
  .setup-step{display:flex;gap:20px;padding:24px 0;border-bottom:1px solid var(--gray-light);}
  .setup-step:last-child{border-bottom:none;}
  .step-num{width:36px;height:36px;border-radius:50%;background:var(--black);color:white;
    display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;flex-shrink:0;margin-top:2px;}
  .step-content h4{font-size:16px;font-weight:700;margin-bottom:6px;}
  .step-content p{font-size:14px;color:var(--gray-mid);line-height:1.6;margin-bottom:10px;}
  .step-content code{display:block;background:#1e1e2e;color:#4ABDE8;border-radius:8px;padding:12px 16px;
    font-size:13px;font-family:monospace;line-height:1.7;white-space:pre-wrap;word-break:break-all;margin-top:8px;}
  .step-content .copy-btn{margin-top:8px;padding:7px 16px;background:var(--sky-light);color:var(--sky-dark);
    border:none;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:background .2s;}
  .step-content .copy-btn:hover{background:var(--sky-dark);color:white;}
  .url-input-row{display:flex;gap:10px;margin-top:10px;}
  .url-field{flex:1;border:2px solid var(--gray-light);border-radius:8px;padding:12px 14px;
    font-size:14px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color .2s;}
  .url-field:focus{border-color:var(--sky);}
  .url-save-btn{padding:12px 20px;background:var(--black);color:white;border:none;border-radius:8px;
    font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap;transition:background .2s;}
  .url-save-btn:hover{background:var(--gray-dark);}
  .setup-done-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--sky-dark),var(--sky));
    color:white;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:16px;
    font-weight:700;cursor:pointer;margin-top:8px;transition:opacity .2s;}
  .setup-done-btn:hover{opacity:0.9;}

  @media(max-width:640px){
    .intro-hero{padding:36px 24px;}
    .intro-hero h1{font-size:26px;}
    .stats-row,.admin-summary-row{grid-template-columns:1fr 1fr;}
    .tf-grid{flex-direction:column;}
    .q-card,.name-card{padding:20px;}
    .detail-grid{grid-template-columns:1fr;}
    .admin-header-bar{padding:24px;}
    .setup-card{padding:28px 24px;}
    .site-header{padding:0 20px;}
  }
  @media print{
    .site-header,.submit-btn,.print-btn,.save-results-btn,.check-btn,.setup-banner{display:none!important;}
    .wrapper{padding:0;}
  }
</style>
</head>
<body>

<header class="site-header">
  <div class="logo">Savvy <span>Realty</span></div>
  <div class="header-right">
    <div class="header-badge" id="header-badge">VA Training Assessment</div>
    <button class="admin-link" id="admin-nav-btn" onclick="goAdminLogin()">Admin ‚Üó</button>
  </div>
</header>

<!-- Setup banner shown when no script URL is saved -->
<div class="setup-banner" id="setup-banner" style="display:none;">
  <span class="icon">‚öôÔ∏è</span>
  <span><strong>One-time setup needed:</strong> Connect this file to Google Sheets so scores sync across browsers.
  <a onclick="showScreen('screen-setup')">Open Setup Guide ‚Üí</a></span>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     INTRO SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-intro" class="screen active">
  <div class="wrapper">
    <div class="intro-hero">
      <h1>Listings VA<br><em>Certification Assessment</em></h1>
      <p>This 40-question assessment covers everything from your core training modules: lead flow, CRM management, Rabbu imports, skip tracing, reporting, SmartPlans, and more.</p>
      <div class="intro-meta">
        <div class="meta-chip"><span>üìã</span> 40 Questions</div>
        <div class="meta-chip"><span>‚ö°</span> Mixed Formats</div>
        <div class="meta-chip"><span>‚úçÔ∏è</span> 5 Written Responses</div>
        <div class="meta-chip"><span>üéØ</span> Focus: Lead Flow & Imports</div>
      </div>
    </div>
    <div class="name-card">
      <label for="trainee-name">Your Full Name</label>
      <input type="text" class="field-input" id="trainee-name" placeholder="Enter your name before starting‚Ä¶" autocomplete="name">
    </div>
    <div class="info-box">
      <strong>üìå Instructions:</strong> Questions are grouped by topic. Multiple choice, true/false, and fill-in-the-blank answers are graded instantly. Written responses are reviewed by your manager in the Admin Dashboard. Click Check Answer on each question to see feedback as you go.
    </div>
    <button class="btn-primary" onclick="startAssessment()" style="width:100%;padding:18px;font-size:17px;">Begin Assessment ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ASSESSMENT SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-assessment" class="screen">
  <div class="wrapper">
    <div class="progress-label">
      <span id="progress-text">0% Complete</span>
      <span id="score-live">Auto-score: 0 / 0 graded</span>
    </div>
    <div class="progress-bar-wrap"><div class="progress-bar-fill" id="progress-fill" style="width:0%"></div></div>
    <div id="questions-container"></div>
    <button class="submit-btn" onclick="submitAssessment()">Submit Assessment & View Results ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     RESULTS SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-results" class="screen">
  <div class="wrapper">
    <div class="result-hero">
      <div class="score-ring" id="score-ring">
        <div class="score-inner">
          <div class="score-pct" id="score-pct">0%</div>
          <div class="score-sub">Auto-Graded</div>
        </div>
      </div>
      <h2 id="result-heading">Assessment Complete!</h2>
      <p>Results for <strong id="result-name"></strong> &nbsp;¬∑&nbsp; <span id="result-date"></span></p>
    </div>
    <div class="stats-row">
      <div class="stat-card green"><div class="val" id="stat-correct">0</div><div class="lbl">Correct</div></div>
      <div class="stat-card red">  <div class="val" id="stat-wrong">0</div><div class="lbl">Incorrect</div></div>
      <div class="stat-card gold"> <div class="val">5</div><div class="lbl">Pending Review</div></div>
    </div>
    <div class="grading-section">
      <h3>‚úçÔ∏è Written Response Grading</h3>
      <p class="sub">These will be reviewed by your manager in the Admin Dashboard. You can optionally self-grade here first.</p>
      <div id="manual-grading-area"></div>
      <button class="final-score-btn" onclick="calcFinalScore()">Calculate Estimated Score</button>
      <div class="final-score-display" id="final-score-display">
        <div class="big" id="final-pct">‚Äî</div>
        <div class="detail" id="final-detail">‚Äî</div>
      </div>
    </div>
    <button class="save-results-btn idle" id="save-btn" onclick="saveResults()">
      ‚òÅÔ∏è Submit Results to Admin Dashboard
    </button>
    <button class="print-btn" onclick="window.print()">üñ® Print / Save as PDF</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ADMIN LOGIN SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-admin-login" class="screen">
  <div class="admin-login-wrap">
    <div class="admin-login-card">
      <div class="admin-lock">üîê</div>
      <h2>Admin Access</h2>
      <p>Enter the admin password to view all VA submissions and grade written responses.</p>
      <input type="password" class="admin-pw-input" id="admin-pw" placeholder="Password"
        onkeydown="if(event.key==='Enter')tryAdminLogin()">
      <button class="admin-login-btn" onclick="tryAdminLogin()">Sign In ‚Üí</button>
      <div class="admin-error" id="admin-error"></div>
      <br>
      <button class="admin-back" onclick="showScreen('screen-intro')">‚Üê Back to Assessment</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ADMIN DASHBOARD SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-admin" class="screen">
  <div class="wrapper">
    <div class="admin-header-bar">
      <div>
        <h1>Admin Dashboard</h1>
        <p>Savvy Realty ‚Äî VA Training Assessment Results</p>
      </div>
      <div class="admin-header-right">
        <button class="admin-refresh-btn" id="refresh-btn" onclick="loadAdminData()">‚Üª Refresh</button>
        <button class="admin-refresh-btn" onclick="showSetupFromAdmin()" style="border-color:rgba(255,255,255,0.2);color:rgba(255,255,255,0.5);">‚öôÔ∏è Setup</button>
        <button class="admin-logout-btn" onclick="adminLogout()">Sign Out</button>
      </div>
    </div>

    <div id="admin-sync-status"></div>
    <div class="admin-summary-row" id="admin-summary-row">
      <div class="admin-stat sky"><div class="av">‚Äî</div><div class="al">Total Submissions</div></div>
      <div class="admin-stat grn"><div class="av">‚Äî</div><div class="al">Fully Graded</div></div>
      <div class="admin-stat gold"><div class="av">‚Äî</div><div class="al">Pending Review</div></div>
      <div class="admin-stat"><div class="av">‚Äî</div><div class="al">Avg Auto-Score</div></div>
    </div>

    <div class="submissions-card">
      <div class="submissions-card-header">
        <h3>Submissions</h3>
      </div>
      <div id="submissions-list">
        <div class="no-submissions"><div class="icon">‚è≥</div>Loading submissions‚Ä¶</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SETUP GUIDE SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-setup" class="screen">
  <div class="wrapper">
    <div class="setup-card">
      <h2>‚öôÔ∏è Google Sheets Setup Guide</h2>
      <p class="lead">Follow these 5 steps to connect this assessment to a Google Sheet. Once done, every submission syncs automatically and your whole team can view results from the Admin Dashboard ‚Äî on any browser, any device.</p>

      <div class="setup-steps">

        <div class="setup-step">
          <div class="step-num">1</div>
          <div class="step-content">
            <h4>Create a new Google Sheet</h4>
            <p>Go to <strong>sheets.google.com</strong>, create a blank spreadsheet, and name it something like <em>"Savvy VA Assessment Results"</em>. Leave it open ‚Äî you'll need it in the next step.</p>
          </div>
        </div>

        <div class="setup-step">
          <div class="step-num">2</div>
          <div class="step-content">
            <h4>Open the Script Editor</h4>
            <p>In your new Google Sheet, click the menu: <strong>Extensions ‚Üí Apps Script</strong>. A new tab will open with a code editor. Delete anything in the editor, then paste the entire contents of the <strong>savvy-assessment-script.gs</strong> file provided with this package.</p>
          </div>
        </div>

        <div class="setup-step">
          <div class="step-num">3</div>
          <div class="step-content">
            <h4>Deploy as a Web App</h4>
            <p>In the Apps Script editor, click <strong>Deploy ‚Üí New Deployment</strong>. Configure it like this:</p>
            <code>Type:               Web App
Description:        Savvy VA Assessment
Execute as:         Me
Who has access:     Anyone</code>
            <p style="margin-top:10px;">Click <strong>Deploy</strong>, authorize when prompted, then <strong>copy the Web App URL</strong> ‚Äî you'll need it in Step 5.</p>
          </div>
        </div>

        <div class="setup-step">
          <div class="step-num">4</div>
          <div class="step-content">
            <h4>Share this HTML file with your team</h4>
            <p>Save this HTML file somewhere your whole team can access it ‚Äî a shared Google Drive folder works perfectly. Everyone opens the same file in their browser. No server or hosting needed.</p>
          </div>
        </div>

        <div class="setup-step">
          <div class="step-num">5</div>
          <div class="step-content">
            <h4>Paste your Web App URL below</h4>
            <p>Paste the URL you copied in Step 3. Once saved, all submissions will sync to your Google Sheet automatically.</p>
            <div class="url-input-row">
              <input type="text" class="url-field" id="script-url-input"
                placeholder="https://script.google.com/macros/s/‚Ä¶/exec">
              <button class="url-save-btn" onclick="saveScriptUrl()">Save URL</button>
            </div>
            <p id="url-save-status" style="font-size:13px;margin-top:8px;color:var(--green);display:none;">‚úÖ URL saved! The assessment is now connected to Google Sheets.</p>
          </div>
        </div>

      </div>
    </div>
    <button class="setup-done-btn" onclick="finishSetup()">I'm Done ‚Äî Go to Admin Dashboard ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DATA & JAVASCRIPT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG  ‚Äî set by setup guide
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADMIN_PASSWORD = 'SavvyAdmin2026';
const SCRIPT_URL_KEY = 'savvy_script_url';

function getScriptUrl() { return localStorage.getItem(SCRIPT_URL_KEY) || ''; }

// Show setup banner on load if no URL configured
window.addEventListener('load', () => {
  if (!getScriptUrl()) document.getElementById('setup-banner').style.display = 'flex';
});

function saveScriptUrl() {
  const url = document.getElementById('script-url-input').value.trim();
  if (!url.startsWith('https://script.google.com')) {
    alert('Please enter a valid Google Apps Script URL (starts with https://script.google.com)');
    return;
  }
  localStorage.setItem(SCRIPT_URL_KEY, url);
  document.getElementById('url-save-status').style.display = 'block';
  document.getElementById('setup-banner').style.display = 'none';
}

function finishSetup() {
  if (!getScriptUrl()) { alert('Please complete Step 5 and save your Script URL first.'); return; }
  showScreen('screen-admin-login');
}

function showSetupFromAdmin() {
  const url = getScriptUrl();
  if (url) document.getElementById('script-url-input').value = url;
  showScreen('screen-setup');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QUESTION BANK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const questions = [
  // SECTION 1 ‚Äî Systems & Tools
  { section:"Section 1 ‚Äî Systems & Tools", sectionAccent:false,
    id:1, type:"mc",
    q:"What is the <span class='highlight'>primary CRM system</span> used at Savvy Realty for lead communication, scheduling, and follow-ups?",
    options:["Airtable","Google Drive","Softy (Lofty)","HubSpot"], answer:2,
    feedback:"Softy (Lofty) is Savvy's primary CRM. All leads live here, all text conversations happen here, and scheduling is done here." },
  { id:2, type:"mc",
    q:"Which tool is used specifically for <span class='highlight'>tracking and reporting</span> listing calls, appointments, agent connections, and referral partners?",
    options:["Gmail","Lofty (Softy)","Airtable","Google Calendar"], answer:2,
    feedback:"Airtable is the tracking and reporting tool where you log listing calls, appointments, and agent connections." },
  { id:3, type:"tf",
    q:"Gmail is used at Savvy primarily for agent outreach, status update emails, and referral coordination.",
    answer:true, feedback:"Correct ‚Äî Gmail handles agent outreach, follow-up emails, and referral coordination." },
  { id:4, type:"mc",
    q:"When scheduling in Google Calendar, what is the most critical detail to always confirm with the lead?",
    options:["Their property square footage","Their timezone","Their preferred agent","Their Rabbu registration date"], answer:1,
    feedback:"Timezone confirmation is critical to avoid scheduling errors across different regions." },
  { id:5, type:"tf",
    q:"Savvy Realty specializes in short-term rental (STR) real estate and primarily works with investors, not traditional home sellers.",
    answer:true, feedback:"Correct ‚Äî Savvy is STR-focused, works on a national scale, and serves investors primarily." },

  // SECTION 2 ‚Äî Lead Flow & Communication
  { section:"Section 2 ‚Äî Lead Flow & Communication", sectionAccent:true,
    id:6, type:"mc",
    q:"What is the <span class='highlight'>primary objective</span> of every text conversation a VA has with a lead in Softy?",
    options:["Educate the lead about STRs","Negotiate listing price over text","Schedule the lead for a Listings ISA call","Explain Savvy's commission structure"], answer:2,
    feedback:"The #1 goal is always to schedule the lead for a Listings ISA call. We do NOT educate, value properties, or negotiate over text." },
  { id:7, type:"mc",
    q:"After a Listings ISA call results in a qualified lead, what is the VA's next responsibility?",
    options:["Send a listing agreement","Coordinate the agent connection and schedule the listing appointment","Email the lead's Rabbu record","Close the lead in Lofty"], answer:1,
    feedback:"After an ISA call qualifies the lead, the VA coordinates the agent connection and schedules the listing appointment." },
  { id:8, type:"tf",
    q:"You should unsubscribe a lead from Softy if they have low engagement and haven't responded to your last 3 messages.",
    answer:false, feedback:"Incorrect ‚Äî do NOT unsubscribe due to low engagement. Only unsubscribe when a lead explicitly says they are not interested or requests no further contact." },
  { id:9, type:"mc",
    q:"When using text templates in Softy, what is the best practice for making messages feel natural?",
    options:["Paste the template exactly as written","Never use templates","Read it, adjust wording slightly so it sounds human, and personalize with the lead's name","Send multiple templates back-to-back"], answer:2,
    feedback:"Templates ensure consistency but should be slightly personalized so they don't sound robotic. Always use the lead's name and context." },
  { id:10, type:"fill",
    q:"When a lead asks a question not covered by your templates, answer briefly, redirect toward a call, and if unsure, flag the conversation for the ___________.",
    answer:"listings manager",
    feedback:"Unsure conversations should always be flagged for the Listings Manager rather than guessing." },

  // SECTION 3 ‚Äî Scheduling & Appointments
  { section:"Section 3 ‚Äî Scheduling & Appointments", sectionAccent:false,
    id:11, type:"mc",
    q:"Immediately after scheduling a listing ISA call, what must you log in Airtable?",
    options:["The lead's Rabbu source tag","A 'Listing Call' entry with client name, date/time, and assigned ISA","The lead's skip trace status","The agent's referral agreement"], answer:1,
    feedback:"After every scheduling, immediately open Airtable and log a 'Listing Call' with client name, date/time, and assigned ISA." },
  { id:12, type:"tf",
    q:"When sending a call confirmation text to a lead, you must include the date, time, timezone, and who they'll be speaking with.",
    answer:true, feedback:"All four are required in a confirmation text: date, time, timezone, and the name of who they'll speak with." },
  { id:13, type:"mc",
    q:"When connecting a client with an agent, what should you do BEFORE sending the agent's information?",
    options:["Email Schumi for approval","Confirm the appointment time is set first","Run a skip trace on the client","Update the Rabbu Sellers Database"], answer:1,
    feedback:"Do not send agent info until the appointment is confirmed. Confirm appointment times and timezones first." },
  { id:14, type:"mc",
    q:"After a referral agent is introduced to a client, what follow-up task must be set?",
    options:["24-hour check-in","1-week follow-up with the client","Bi-daily status email","30-day check-in only"], answer:1,
    feedback:"A 1-week follow-up task must always be set after every agent appointment or introduction." },
  { id:15, type:"tf",
    q:"The Listings ISA is responsible for sending the email introduction between client and agent ‚Äî your job is system accuracy and task completion.",
    answer:true, feedback:"Correct ‚Äî the ISA handles the email intro, but you're responsible for logging, confirming, and task management." },

  // SECTION 4 ‚Äî Rabbu Lead Import (FOCUS AREA)
  { section:"Section 4 ‚Äî Rabbu Lead Import to Lofty", sectionAccent:true,
    id:16, type:"mc",
    q:"At what time each morning does Savvy receive the Rabbu email with new lead data?",
    options:["7:00 a.m.","8:30 a.m.","9:00 a.m.","10:00 a.m."], answer:2,
    feedback:"Every morning at 9:00 a.m., an email from Rabbu contains a screenshot of the 20 most recent leads." },
  { id:17, type:"mc",
    q:"Why can the Rabbu import process NOT be fully automated?",
    options:["Lofty doesn't support CSV imports","Savvy does not currently have direct access to the Rabbu database","Rabbu only sends leads weekly","The leads must be manually re-typed"], answer:1,
    feedback:"Savvy doesn't have direct database access to Rabbu, so it requires daily manual review and import." },
  { id:18, type:"mc",
    q:"After downloading the Rabbu Metabase CSV, what is the FIRST filtering step before importing into Lofty?",
    options:["Remove leads with low Rabbu scores","Remove leads without usable contact info (no phone AND no email)","Remove leads outside the US","Remove leads added more than 30 days ago"], answer:1,
    feedback:"The first step is removing no-contact leads ‚Äî those with no phone AND no email. These go to a separate sheet for future skip tracing." },
  { id:19, type:"mc",
    q:"Why should leads listed as 'Agent' under Seller Type be removed from the Rabbu import?",
    options:["Agents don't have property to sell","Agents are typically not interested in speaking with other agents ‚Äî conversations are unproductive","Agents are already in Lofty","Agents require a special import workflow"], answer:1,
    feedback:"Agents are typically not interested in agent-to-agent conversations, making these imports a waste of outreach time." },
  { id:20, type:"mc",
    q:"When mapping fields during the Lofty import, which address field must you use for Rabbu seller leads?",
    options:["Mailing Address","Property Full Address (Selling)","Current Residence Address","Business Address"], answer:1,
    feedback:"Always use 'Property Full Address (Selling)' ‚Äî NOT the mailing address. This is a critical field mapping rule." },
  { id:21, type:"tf",
    q:"You should import the Rabbu Registration Date into Lofty to track when leads first registered.",
    answer:false, feedback:"DO NOT import the Registration Date. It reflects when the lead registered with Rabbu ‚Äî not when they entered Savvy's CRM ‚Äî creating misleading data." },
  { id:22, type:"mc",
    q:"What should be imported as a <span class='highlight'>Note</span> in Lofty during a Rabbu import?",
    options:["The lead's name and email","Property URL, asking price, gross yield/revenue","Agent assignment and lead stage","Registration date and Seller Type"], answer:1,
    feedback:"Property URL, asking price, and gross yield/revenue should be imported as Notes to keep Lofty clean while preserving context." },
  { id:23, type:"tf",
    q:"On the final Lofty import screen, you should check all available boxes to maximize data capture.",
    answer:false, feedback:"DO NOT check any boxes on the final import screen. Proceed with the import as-is." },
  { id:24, type:"mc",
    q:"After importing Rabbu leads into Lofty, what TWO tags must be applied?",
    options:['"Seller" and "STR"','"Rabbu" and "Rabbu Smart Plan"','"New Lead" and "Rabbu Import"','"Cold" and "Rabbu Outreach"'], answer:1,
    feedback:"After import, navigate to People, select the new leads, and apply both 'Rabbu' (source) and 'Rabbu Smart Plan' tags." },
  { id:25, type:"fill",
    q:"Because Smart Plan automation is not yet fully enabled, after tagging imported Rabbu leads you must manually apply the ___________ to ensure immediate outreach.",
    answer:"rabbu smart plan",
    feedback:"The Rabbu Smart Plan must be manually applied to all new Rabbu leads to trigger consistent outreach." },

  // SECTION 5 ‚Äî Lead Tracking & Reporting (FOCUS AREA)
  { section:"Section 5 ‚Äî Lead Tracking & Reporting", sectionAccent:false,
    id:26, type:"mc",
    q:"Anytime a listing appointment is booked, in how many places inside the Listings Reporting workbook must it be entered?",
    options:["Once ‚Äî in All Listing Appointments Set only","Twice ‚Äî in All Listing Appointments Set AND the appropriate agent/referral sheet","Three times ‚Äî All Appointments, Agent Sheet, and Rabbu DB","Only if the lead source is Rabbu"], answer:1,
    feedback:"Every listing appointment must be entered in two places: 'All Listing Appointments Set' AND one agent sheet (individual agent or Referral Listing Appts)." },
  { id:27, type:"mc",
    q:"How do you determine whether to log a listing appointment in an individual agent sheet vs. the Referral Listing Appts sheet?",
    options:["Based on the lead source","Check Airtable ‚Üí Buyers Agent tab to see if the agent is a Savvy expansion agent","Ask the Listings ISA","Check if the agent has a Gmail address"], answer:1,
    feedback:"Open Airtable ‚Üí Buyers Agent tab, search the agent's name. Expansion agent ‚Üí individual sheet. Not listed ‚Üí Referral Listing Appts." },
  { id:28, type:"tf",
    q:"If the Dashboard tab in the Listings Reporting sheet looks incorrect, you should fix the formula yourself to save time.",
    answer:false, feedback:"NEVER edit the Dashboard tab. It contains formulas ‚Äî editing it breaks reporting accuracy. Notify the Listings Manager immediately." },
  { id:29, type:"mc",
    q:"A Rabbu listing appointment must be logged in how many sheets?",
    options:["Only the Rabbu Sellers Database","Only the Listings Reporting sheet","Both the Listings Reporting sheet AND the Rabbu Sellers Database","Only Airtable"], answer:2,
    feedback:"Rabbu listing appointments go in BOTH places: Listings Reporting (all appointments) AND the Rabbu Sellers Database (Rabbu-specific tracking)." },
  { id:30, type:"mc",
    q:"Which of the following status changes requires you to update the Rabbu Sellers Database?",
    options:["A cold outbound lead responds","A Rabbu lead schedules a listing appointment","An expansion agent completes a closing","A non-Rabbu referral agent is onboarded"], answer:1,
    feedback:"Any Rabbu lead status change must be updated in the Rabbu Sellers Database ‚Äî scheduling, connections, completions, going cold." },

  // SECTION 6 ‚Äî Weekly Reporting
  { section:"Section 6 ‚Äî Weekly Reporting", sectionAccent:true,
    id:31, type:"mc",
    q:"To find how many leads came from a specific source in Lofty for the weekly report, which filter do you use?",
    options:["Lead Stage filter","Tags filter ‚Äî select the desired lead source","Registration Date > 30 days","Owner filter by ISA name"], answer:1,
    feedback:"In Lofty ‚Üí All Leads, use the Tags filter and select the desired lead source tag to count leads from that source." },
  { id:32, type:"tf",
    q:"When pulling weekly lead flow data in Lofty, you should filter by 'Reg Date ‚Üí Last 7 Days' to capture all leads from the past week.",
    answer:true, feedback:"Correct ‚Äî navigate to All Leads in Lofty and apply the 'Reg Date ‚Üí Last 7 Days' filter for weekly reporting." },
  { id:33, type:"mc",
    q:"The weekly reporting email must always be sent to which group?",
    options:["Only the Listings Manager","Everyone in the Listings Department, Tyler, and Elana","Only Tyler and the assigned ISA","The entire Savvy Realty team"], answer:1,
    feedback:"The weekly email must go to everyone in the Listings Department, Tyler, and Elana. Do not remove recipients without approval." },

  // SECTION 7 ‚Äî SmartPlan Management
  { section:"Section 7 ‚Äî SmartPlan Management", sectionAccent:false,
    id:34, type:"mc",
    q:"The Auto-Pause feature in SmartPlans should ALWAYS be checked ‚Äî except when?",
    options:["When the lead is a Rabbu source","When the SmartPlan is a long-term campaign (e.g., daily email nurture)","When the lead hasn't responded after 3 days","When importing more than 50 leads at once"], answer:1,
    feedback:"Auto-Pause should always be enabled EXCEPT for long-term nurture campaigns where continuous messaging is intentional." },
  { id:35, type:"mc",
    q:"All SmartPlan response times must be set within which hours?",
    options:["9:00 AM ‚Äì 5:00 PM","8:00 AM ‚Äì 8:00 PM","11:00 AM ‚Äì 7:00 PM","10:00 AM ‚Äì 6:00 PM"], answer:2,
    feedback:"All SmartPlans must have response times within 11:00 AM ‚Äì 7:00 PM to account for time zones and protect brand professionalism." },
  { id:36, type:"tf",
    q:"After a one-off SmartPlan campaign completes, you must turn off the Auto-Apply feature to prevent it triggering for future leads.",
    answer:true, feedback:"Correct ‚Äî if Auto-Apply is left on after a one-time campaign, the SmartPlan will continue triggering for future leads unintentionally." },

  // SECTION 8 ‚Äî Skip Tracing
  { section:"Section 8 ‚Äî Skip Tracing (AirDNA ‚Üí Miraz)", sectionAccent:true,
    id:37, type:"mc",
    q:"What is the maximum number of properties per AirDNA export, and why does this limit exist?",
    options:["250 ‚Äî AirDNA's free tier limit","500 ‚Äî AirDNA only exports the first 10 pages of results","1,000 ‚Äî Miraz's processing limit","Unlimited ‚Äî no export cap"], answer:1,
    feedback:"AirDNA limits exports to the first 10 pages (~500 listings). Lists exceeding this will miss properties unless broken into smaller segments." },
  { id:38, type:"mc",
    q:"When importing multiple AirDNA CSV files into a Google Sheet, which import option MUST you always select?",
    options:["Replace Current Sheet","Create New Spreadsheet","INSERT SHEET","Append to Current Sheet"], answer:2,
    feedback:"Always use INSERT SHEET to keep all data in one workbook. This is critical for Miraz's workflow and data organization." },

  // SECTION 9 ‚Äî Written Responses
  { section:"Section 9 ‚Äî Client Communication (Written Responses)", sectionAccent:false,
    id:39, type:"written",
    q:"A Rabbu lead named Marcus has just responded to your initial outreach text saying: <em>\"I might be interested but I'm not sure yet. What exactly does Savvy do?\"</em><br><br>Write a professional text response that follows Savvy's communication philosophy ‚Äî warm, brief, not over-explaining, guiding toward a call.",
    placeholder:"Write your text response to Marcus here‚Ä¶",
    guidance:"Look for: warm greeting using Marcus's name, brief 1‚Äì2 sentence description of Savvy (STR-focused, investor-focused), clear call-to-action to schedule a quick call, professional tone, avoids over-explaining or selling." },
  { id:40, type:"written",
    q:"A client named Sandra was supposed to have her listing appointment today, but the agent just messaged you saying he needs to reschedule for next week. Write a text to Sandra letting her know about the reschedule ‚Äî professional, apologetic, and solution-oriented.",
    placeholder:"Write your text to Sandra here‚Ä¶",
    guidance:"Look for: uses Sandra's name, acknowledges the reschedule clearly, apologizes without over-apologizing, offers a next step or asks for availability, maintains professionalism and warmth." },
  { id:"39b", type:"written",
    q:"Explain in 2‚Äì3 sentences why Rabbu leads should NEVER have their Registration Date imported into Lofty, using your own words.",
    placeholder:"Your explanation here‚Ä¶",
    guidance:"Look for: understanding that Registration Date reflects when they joined Rabbu ‚Äî not when they entered Savvy's CRM ‚Äî importing it would create misleading timeline data inside Lofty." },
  { id:"39c", type:"written",
    q:"A new VA accidentally logged a Rabbu lead's listing appointment into ONLY the Rabbu Sellers Database and forgot the Listings Reporting sheet. Explain the correct action and why this mistake matters.",
    placeholder:"Your explanation here‚Ä¶",
    guidance:"Look for: all listing appointments go into Listings Reporting regardless of source; Rabbu appointments go in BOTH sheets; explains why it matters (partnership reporting, performance tracking, leadership visibility)." },
  { id:"39d", type:"written",
    q:"You're about to run a skip trace for the Pocono Mountains market and AirDNA shows 18,600 STR properties. Walk through your full strategy.",
    placeholder:"Describe your skip trace strategy here‚Ä¶",
    guidance:"Look for: must break market into submarkets; each export ‚â§500 properties; apply filters like bedroom count/review rating; continue until all submarkets covered; exports labeled clearly; data compiled into single workbook using INSERT SHEET; copy to Miraz Sheets folder." }
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let userAnswers  = {};
let checked      = {};
let autoScore    = 0;
let autoTotal    = 0;
let manualGrades = {};
let gradeNotes   = {};
let submissionId = null;
let resultsSaved = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  START ASSESSMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startAssessment() {
  const name = document.getElementById('trainee-name').value.trim();
  if (!name) {
    const inp = document.getElementById('trainee-name');
    inp.style.borderColor='var(--red)'; inp.focus(); return;
  }
  showScreen('screen-assessment');
  renderQuestions();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER QUESTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderQuestions() {
  const container = document.getElementById('questions-container');
  container.innerHTML = '';
  let qNum = 1;
  questions.forEach(q => {
    if (q.section) {
      const div = document.createElement('div');
      div.className = 'section-divider';
      div.innerHTML = `<div class="section-divider-label ${q.sectionAccent?'accent':''}">${q.section}</div><div class="section-divider-line"></div>`;
      container.appendChild(div);
    }
    const card = document.createElement('div');
    card.className = 'q-card'; card.id = `card-${q.id}`;
    let html = `<div class="q-number">Q${qNum} of 40 &nbsp;¬∑&nbsp; ${typeLabel(q.type)}</div><div class="q-text">${q.q}</div>`;
    if (q.type==='mc') {
      html += `<div class="options-grid">`+q.options.map((o,i)=>
        `<button class="option-btn" id="opt-${q.id}-${i}" onclick="selectMC('${q.id}',${i})">
          <div class="option-letter">${String.fromCharCode(65+i)}</div><span>${o}</span></button>`
      ).join('')+`</div>`+checkBtnHtml(q.id);
    } else if (q.type==='tf') {
      html += `<div class="tf-grid">
        <button class="tf-btn" id="tf-${q.id}-true" onclick="selectTF('${q.id}',true)">‚úì True</button>
        <button class="tf-btn" id="tf-${q.id}-false" onclick="selectTF('${q.id}',false)">‚úó False</button>
      </div>`+checkBtnHtml(q.id);
    } else if (q.type==='fill') {
      html += `<input class="fill-input" id="fill-${q.id}" placeholder="Type your answer here‚Ä¶" onkeydown="if(event.key==='Enter')checkFill('${q.id}')">
               <button class="check-btn" onclick="checkFill('${q.id}')">Check Answer</button>`;
    } else if (q.type==='written') {
      html += `<div class="written-label">‚úèÔ∏è Written Response <span class="badge-manual">Manual Grading</span></div>
               <textarea class="written-area" id="written-${q.id}" placeholder="${q.placeholder}" oninput="saveWritten('${q.id}')"></textarea>`;
    }
    html += `<div class="q-feedback" id="feedback-${q.id}"></div>`;
    card.innerHTML = html;
    container.appendChild(card);
    qNum++;
  });
  updateProgress();
}
function typeLabel(t){return{mc:'Multiple Choice',tf:'True / False',fill:'Fill in the Blank',written:'Written Response'}[t];}
function checkBtnHtml(id){return `<button class="check-btn" id="chk-${id}" onclick="checkAnswer('${id}')" disabled>Check Answer</button>`;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INTERACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectMC(id,idx){
  if(checked[id])return;
  userAnswers[id]=idx;
  const q=getQ(id);
  q.options.forEach((_,i)=>document.getElementById(`opt-${id}-${i}`).classList.toggle('selected',i===idx));
  document.getElementById(`chk-${id}`).disabled=false;
  updateProgress();
}
function selectTF(id,val){
  if(checked[id])return;
  userAnswers[id]=val;
  document.getElementById(`tf-${id}-true`).classList.toggle('selected',val===true);
  document.getElementById(`tf-${id}-false`).classList.toggle('selected',val===false);
  document.getElementById(`chk-${id}`).disabled=false;
  updateProgress();
}
function checkAnswer(id){
  if(checked[id])return;
  const q=getQ(id); const ua=userAnswers[id];
  if(ua===undefined)return;
  checked[id]=true;
  const correct=(q.type==='mc')?ua===q.answer:ua===q.answer;
  autoTotal++; if(correct)autoScore++;
  document.getElementById(`card-${id}`).classList.add(correct?'correct':'incorrect');
  if(q.type==='mc'){
    q.options.forEach((_,i)=>{
      const btn=document.getElementById(`opt-${id}-${i}`); btn.disabled=true;
      if(i===q.answer)btn.classList.add('correct-ans');
      else if(i===ua&&!correct)btn.classList.add('wrong-ans');
      else btn.classList.remove('selected');
    });
  } else {
    ['true','false'].forEach(v=>{document.getElementById(`tf-${id}-${v}`).disabled=true;});
    document.getElementById(`tf-${id}-${q.answer}`).classList.add('correct-ans');
    if(!correct)document.getElementById(`tf-${id}-${ua}`).classList.add('wrong-ans');
  }
  const chk=document.getElementById(`chk-${id}`);
  chk.disabled=true; chk.textContent=correct?'‚úì Correct!':'‚úó Incorrect';
  chk.style.background=correct?'var(--green)':'var(--red)';
  showFeedback(id,correct,q.feedback);
  updateProgress();
}
function checkFill(id){
  if(checked[id])return;
  const q=getQ(id); const input=document.getElementById(`fill-${id}`);
  const val=input.value.trim().toLowerCase(); const ans=q.answer.toLowerCase();
  const correct=val===ans||val.includes(ans)||ans.includes(val);
  checked[id]=true; autoTotal++; if(correct)autoScore++;
  input.disabled=true; input.classList.add(correct?'correct':'incorrect');
  document.getElementById(`card-${id}`).classList.add(correct?'correct':'incorrect');
  const btn=input.nextElementSibling; btn.disabled=true;
  btn.textContent=correct?`‚úì Correct! (${q.answer})`:`‚úó Incorrect ‚Äî Answer: ${q.answer}`;
  btn.style.background=correct?'var(--green)':'var(--red)';
  showFeedback(id,correct,q.feedback); updateProgress();
}
function saveWritten(id){
  userAnswers[id]=document.getElementById(`written-${id}`).value;
  document.getElementById(`card-${id}`).classList.toggle('answered',userAnswers[id].trim().length>0);
  updateProgress();
}
function showFeedback(id,correct,text){
  const el=document.getElementById(`feedback-${id}`);
  el.className=`q-feedback show ${correct?'correct-fb':'incorrect-fb'}`;
  el.innerHTML=`<strong>${correct?'‚úì Well done!':'‚úó Not quite.'}</strong> ${text}`;
}
function updateProgress(){
  const checkedCount=Object.keys(checked).length;
  const writtenFilled=questions.filter(q=>q.type==='written'&&userAnswers[q.id]?.trim()).length;
  const pct=Math.min(Math.round((checkedCount+writtenFilled)/questions.length*100),100);
  document.getElementById('progress-fill').style.width=pct+'%';
  document.getElementById('progress-text').textContent=pct+'% Complete';
  document.getElementById('score-live').textContent=`Auto-score: ${autoScore} / ${autoTotal} graded`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUBMIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function submitAssessment(){
  questions.forEach(q=>{
    if(q.type!=='written'&&userAnswers[q.id]!==undefined&&!checked[q.id]){
      if(q.type==='fill')checkFill(q.id); else checkAnswer(q.id);
    }
  });
  showScreen('screen-results');
  buildResults();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RESULTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildResults(){
  const name=document.getElementById('trainee-name').value.trim()||'VA Trainee';
  const now=new Date();
  document.getElementById('result-name').textContent=name;
  document.getElementById('result-date').textContent=now.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'});
  const pct=autoTotal>0?Math.round(autoScore/autoTotal*100):0;
  document.getElementById('score-pct').textContent=pct+'%';
  document.getElementById('stat-correct').textContent=autoScore;
  document.getElementById('stat-wrong').textContent=autoTotal-autoScore;
  document.getElementById('score-ring').style.background=`conic-gradient(var(--sky) ${pct*3.6}deg, rgba(255,255,255,0.08) 0deg)`;
  document.getElementById('result-heading').textContent=pct>=80?'Great Work! üéâ':pct>=65?'Good Effort!':'Keep Studying!';

  const writtenQs=questions.filter(q=>q.type==='written');
  const area=document.getElementById('manual-grading-area');
  area.innerHTML='';
  writtenQs.forEach((q,i)=>{
    const resp=(userAnswers[q.id]||'').trim()||'<em style="color:var(--gray-mid)">No response entered.</em>';
    area.innerHTML+=`
      <div class="manual-q" id="mq-${q.id}">
        <div class="manual-q-label">Written Q${i+1}</div>
        <div class="manual-q-text">${q.q}</div>
        <div class="manual-q-response">${resp.replace(/\n/g,'<br>')}</div>
        <details style="margin-bottom:12px;">
          <summary style="font-size:13px;color:var(--sky-dark);cursor:pointer;font-weight:600;">üìù Grading Guidance</summary>
          <p style="font-size:13px;color:var(--gray-mid);margin-top:8px;line-height:1.6;">${q.guidance}</p>
        </details>
        <div class="grade-row">
          <span class="grade-label">Self-grade:</span>
          <button class="grade-btn pass"    onclick="setGrade('${q.id}','pass',this)">‚úì Pass (10)</button>
          <button class="grade-btn partial" onclick="setGrade('${q.id}','partial',this)">~ Partial (5)</button>
          <button class="grade-btn fail"    onclick="setGrade('${q.id}','fail',this)">‚úó Fail (0)</button>
        </div>
        <input class="grade-note-input" placeholder="Optional notes‚Ä¶" id="gnote-${q.id}" oninput="gradeNotes['${q.id}']=this.value">
      </div>`;
  });
  submissionId='sub_'+Date.now();
}
function setGrade(id,grade,btn){
  manualGrades[id]=grade;
  btn.closest('.grade-row').querySelectorAll('.grade-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function calcFinalScore(){
  const writtenQs=questions.filter(q=>q.type==='written');
  let mPts=0;
  writtenQs.forEach(q=>{if(manualGrades[q.id]==='pass')mPts+=10;else if(manualGrades[q.id]==='partial')mPts+=5;});
  const totalPts=autoScore+mPts; const maxPts=autoTotal+(writtenQs.length*10);
  const finalPct=Math.round(totalPts/maxPts*100);
  const grade=finalPct>=90?'Excellent':finalPct>=80?'Proficient':finalPct>=65?'Developing':'Needs Review';
  document.getElementById('final-score-display').classList.add('show');
  document.getElementById('final-pct').textContent=finalPct+'%';
  document.getElementById('final-detail').textContent=`${totalPts}/${maxPts} pts ¬∑ ${autoScore}/${autoTotal} auto + ${mPts}/${writtenQs.length*10} written ¬∑ ${grade}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SAVE TO GOOGLE SHEETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveResults(){
  if(resultsSaved)return;
  const scriptUrl=getScriptUrl();
  if(!scriptUrl){
    alert('Google Sheets is not connected yet. Please complete the setup first (Admin ‚Üí Setup).');
    return;
  }
  const btn=document.getElementById('save-btn');
  btn.className='save-results-btn saving'; btn.textContent='‚è≥ Submitting‚Ä¶'; btn.disabled=true;

  const name=document.getElementById('trainee-name').value.trim()||'VA Trainee';
  const now=new Date();
  const writtenQs=questions.filter(q=>q.type==='written');

  // Build answer map
  const answers={};
  questions.forEach(q=>{
    if(q.type!=='written'){
      let ua=userAnswers[q.id];
      let correct=null;
      if(checked[q.id]){
        if(q.type==='fill'){
          const v=(ua||'').toLowerCase(); const a=q.answer.toLowerCase();
          correct=v===a||v.includes(a)||a.includes(v);
        } else { correct=ua===q.answer; }
      }
      answers[q.id]={
        question:q.q.replace(/<[^>]*>/g,''),
        type:q.type, userAnswer:ua,
        correct, correctAnswer:q.answer,
        options:q.options||null
      };
    } else {
      answers[q.id]={
        question:q.q.replace(/<[^>]*>/g,''),
        type:'written', userAnswer:userAnswers[q.id]||'',
        grade:manualGrades[q.id]||null,
        gradeNote:gradeNotes[q.id]||'',
        guidance:q.guidance
      };
    }
  });

  const payload={
    action:'submit', id:submissionId, name,
    dateDisplay:now.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'}),
    autoScore, autoTotal, answers
  };

  try {
    const url=scriptUrl+'?action=submit&data='+encodeURIComponent(JSON.stringify(payload));
    const res=await fetch(url,{redirect:'follow'});
    const text=await res.text();
    const data=JSON.parse(text);
    if(data.ok){
      btn.className='save-results-btn saved'; btn.textContent='‚úÖ Results Saved to Admin Dashboard!';
      resultsSaved=true;
    } else {
      throw new Error(data.error||'Unknown error');
    }
  } catch(err){
    btn.className='save-results-btn error'; btn.textContent='‚ùå Error ‚Äî tap to retry';
    btn.disabled=false;
    btn.onclick=saveResults;
    console.error('Save error:',err);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goAdminLogin(){
  document.getElementById('admin-pw').value='';
  document.getElementById('admin-error').textContent='';
  showScreen('screen-admin-login');
}
function tryAdminLogin(){
  if(document.getElementById('admin-pw').value===ADMIN_PASSWORD){
    document.getElementById('admin-error').textContent='';
    document.getElementById('header-badge').textContent='Admin Dashboard';
    showScreen('screen-admin');
    loadAdminData();
  } else {
    const inp=document.getElementById('admin-pw');
    inp.classList.add('error'); setTimeout(()=>inp.classList.remove('error'),400);
    document.getElementById('admin-error').textContent='Incorrect password. Please try again.';
  }
}
function adminLogout(){
  document.getElementById('header-badge').textContent='VA Training Assessment';
  showScreen('screen-intro');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN DASHBOARD ‚Äî Load from Google Sheets
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAdminData(){
  const scriptUrl=getScriptUrl();
  const statusEl=document.getElementById('admin-sync-status');
  const listEl=document.getElementById('submissions-list');

  if(!scriptUrl){
    statusEl.innerHTML=`<div class="sync-status disconnected">‚ö†Ô∏è Not connected ‚Äî <a href="#" onclick="showSetupFromAdmin()" style="color:inherit;font-weight:700;">complete setup</a> to view submissions</div>`;
    listEl.innerHTML=`<div class="no-submissions"><div class="icon">üîå</div>Google Sheets not connected. Open Setup to configure.</div>`;
    document.getElementById('admin-summary-row').innerHTML=summaryHTML('‚Äî','‚Äî','‚Äî','‚Äî');
    return;
  }

  statusEl.innerHTML=`<div class="sync-status loading">‚è≥ Loading submissions‚Ä¶</div>`;
  const btn=document.getElementById('refresh-btn');
  btn.classList.add('spinning'); btn.disabled=true;

  try {
    const url=`${scriptUrl}?action=getAll`;
    const res=await fetch(url,{redirect:'follow'});
    const text=await res.text();
    const data=JSON.parse(text);
    if(!data.ok) throw new Error(data.error);

    statusEl.innerHTML=`<div class="sync-status connected">‚úÖ Connected to Google Sheets ¬∑ Last refreshed ${new Date().toLocaleTimeString()}</div>`;
    renderAdminDashboard(data.submissions||[]);
  } catch(err){
    statusEl.innerHTML=`<div class="sync-status disconnected">‚ùå Could not reach Google Sheets ‚Äî check your Script URL in Setup</div>`;
    listEl.innerHTML=`<div class="no-submissions"><div class="icon">‚ö†Ô∏è</div>Could not load data. Check the Setup guide and make sure your Web App is deployed correctly.</div>`;
    document.getElementById('admin-summary-row').innerHTML=summaryHTML('‚Äî','‚Äî','‚Äî','‚Äî');
  } finally {
    btn.classList.remove('spinning'); btn.disabled=false;
  }
}

function summaryHTML(total,graded,pending,avg){
  return `
    <div class="admin-stat sky"><div class="av">${total}</div><div class="al">Total Submissions</div></div>
    <div class="admin-stat grn"><div class="av">${graded}</div><div class="al">Fully Graded</div></div>
    <div class="admin-stat gold"><div class="av">${pending}</div><div class="al">Pending Review</div></div>
    <div class="admin-stat"><div class="av">${avg}</div><div class="al">Avg Auto-Score</div></div>`;
}

function renderAdminDashboard(subs){
  const writtenQs=questions.filter(q=>q.type==='written');
  const total=subs.length;
  const graded=subs.filter(s=>s.status&&s.status.includes('Graded')).length;
  const pending=total-graded;
  const avgAuto=total?Math.round(subs.reduce((a,s)=>{
    const p=parseInt(s.autoPct)||0; return a+p;},0)/total)+'%':'‚Äî';
  document.getElementById('admin-summary-row').innerHTML=summaryHTML(total,graded,pending,avgAuto);

  const list=document.getElementById('submissions-list');
  if(!total){
    list.innerHTML=`<div class="no-submissions"><div class="icon">üì≠</div>No submissions yet. Results will appear here once VAs complete and save their assessments.</div>`;
    return;
  }
  list.innerHTML='';
  subs.forEach(sub=>{
    const autoPctNum=parseInt(sub.autoPct)||0;
    const isGraded=sub.status&&sub.status.includes('Graded');
    const pillClass=!isGraded?'pending':autoPctNum>=80?'high':autoPctNum>=65?'mid':'low';
    const pillText=isGraded?(sub.finalPct||sub.autoPct):'Needs Grading';

    const row=document.createElement('div');
    row.className='submission-row'; row.id=`subrow-${sub.id}`;
    row.innerHTML=`
      <div><div class="sub-name">${esc(sub.name)}</div><div class="sub-date">${esc(sub.dateDisplay)}</div></div>
      <div class="sub-scores">
        <span class="score-pill ${pillClass}">${esc(String(pillText))}</span>
        <span class="expand-icon">‚ñæ</span>
      </div>`;
    row.addEventListener('click',()=>toggleDetail(sub.id));
    list.appendChild(row);

    const detail=document.createElement('div');
    detail.className='submission-detail'; detail.id=`subdetail-${sub.id}`;
    detail.innerHTML=buildDetailHtml(sub);
    list.appendChild(detail);
  });
}

function buildDetailHtml(sub){
  const writtenQs=questions.filter(q=>q.type==='written');
  const writtenPts=parseInt(sub.writtenPts)||0;
  const writtenMax=parseInt(sub.writtenMax)||50;
  const totalPts=(parseInt(sub.autoScore)||0)+writtenPts;
  const maxPts=(parseInt(sub.autoTotal)||0)+writtenMax;

  // Auto answers summary
  let ansRows='';
  const autoQs=questions.filter(q=>q.type!=='written');
  autoQs.forEach(q=>{
    const ans=sub.autoAnswers&&sub.autoAnswers[q.id];
    if(!ans){ansRows+=`<div class="answer-item skip"><span class="answer-icon">‚Äî</span><div><div class="answer-qtext">${q.q.replace(/<[^>]*>/g,'').substring(0,80)}‚Ä¶</div><div class="answer-given">Not answered</div></div></div>`;return;}
    const isCorr=ans.result&&ans.result.includes('‚úÖ');
    const isIncr=ans.result&&ans.result.includes('‚ùå');
    ansRows+=`
      <div class="answer-item ${isCorr?'corr':isIncr?'incr':'skip'}">
        <span class="answer-icon">${ans.result||'‚Äî'}</span>
        <div>
          <div class="answer-qtext">${q.q.replace(/<[^>]*>/g,'').substring(0,80)}‚Ä¶</div>
          <div class="answer-given">Answered: <strong>${esc(String(ans.userAnswer||'‚Äî'))}</strong>${isIncr?` ¬∑ Correct: ${esc(String(ans.correctAnswer||''))}`:''}</div>
        </div>
      </div>`;
  });

  // Written grading
  let writtenRows='';
  writtenQs.forEach((q,i)=>{
    const wa=sub.writtenAnswers&&sub.writtenAnswers[q.id];
    const resp=wa?.userAnswer||'';
    const currentGrade=wa?.grade||'';
    const currentNote=wa?.gradeNote||'';
    const gradeKey=currentGrade.includes('Pass')?'pass':currentGrade.includes('Partial')?'partial':currentGrade.includes('Fail')?'fail':'';
    writtenRows+=`
      <div class="admin-written-q">
        <div class="admin-wq-label">Written Q${i+1}</div>
        <div class="admin-wq-text">${q.q.replace(/<[^>]*>/g,'')}</div>
        <div class="admin-wq-resp">${resp?esc(resp).replace(/\n/g,'<br>'):'<em>No response entered.</em>'}</div>
        <details style="margin-bottom:10px;">
          <summary style="font-size:12px;color:var(--sky-dark);cursor:pointer;font-weight:600;">üìù Grading Guidance</summary>
          <div class="detail-guidance" style="margin-top:8px;">${q.guidance}</div>
        </details>
        <div class="admin-grade-row">
          <span class="grade-label">Grade:</span>
          <button class="grade-btn pass    ${gradeKey==='pass'?'active':''}"    onclick="adminSetGrade('${sub.id}','${q.id}','pass',this)">‚úì Pass (10)</button>
          <button class="grade-btn partial ${gradeKey==='partial'?'active':''}" onclick="adminSetGrade('${sub.id}','${q.id}','partial',this)">~ Partial (5)</button>
          <button class="grade-btn fail    ${gradeKey==='fail'?'active':''}"    onclick="adminSetGrade('${sub.id}','${q.id}','fail',this)">‚úó Fail (0)</button>
        </div>
        <input class="admin-grade-note" id="admnote-${sub.id}-${q.id}" placeholder="Feedback notes (optional)‚Ä¶" value="${esc(currentNote)}" oninput="adminNoteInput('${sub.id}','${q.id}',this.value)">
      </div>`;
  });

  return `
    <div class="detail-grid">
      <div class="detail-stat"><div class="dv">${sub.autoScore}/${sub.autoTotal}</div><div class="dl">Auto-Graded Score</div></div>
      <div class="detail-stat"><div class="dv">${writtenPts}/${writtenMax}</div><div class="dl">Written Score</div></div>
      <div class="detail-stat"><div class="dv">${totalPts}/${maxPts}</div><div class="dl">Total Points</div></div>
      <div class="detail-stat"><div class="dv">${sub.finalPct||'Pending'}</div><div class="dl">Final Grade</div></div>
    </div>
    <div class="detail-section-title">Auto-Graded Answers</div>
    <div class="answer-list">${ansRows}</div>
    <div class="detail-section-title" style="margin-top:24px;">Written Responses ‚Äî Grade Here</div>
    ${writtenRows}
    <button class="admin-save-grades-btn" id="admsavebtn-${sub.id}" onclick="adminSaveGrades('${sub.id}')">üíæ Save Grades to Sheet</button>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN GRADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const pendingGrades={};
const pendingNotes={};

function adminSetGrade(subId,qId,grade,btn){
  if(!pendingGrades[subId])pendingGrades[subId]={};
  pendingGrades[subId][qId]=grade;
  btn.closest('.admin-grade-row').querySelectorAll('.grade-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const sb=document.getElementById(`admsavebtn-${subId}`);
  sb.classList.remove('saved'); sb.textContent='üíæ Save Grades to Sheet';
}
function adminNoteInput(subId,qId,val){
  if(!pendingNotes[subId])pendingNotes[subId]={};
  pendingNotes[subId][qId]=val;
}
async function adminSaveGrades(subId){
  const scriptUrl=getScriptUrl();
  if(!scriptUrl){alert('Google Sheets not connected. Please complete setup first.');return;}
  const btn=document.getElementById(`admsavebtn-${subId}`);
  btn.disabled=true; btn.textContent='‚è≥ Saving‚Ä¶';
  const payload={
    action:'saveGrades', id:subId,
    grades:pendingGrades[subId]||{},
    notes:pendingNotes[subId]||{}
  };
  try {
    const url=scriptUrl+'?action=saveGrades&data='+encodeURIComponent(JSON.stringify(payload));
    const res=await fetch(url,{redirect:'follow'});
    const text=await res.text();
    const data=JSON.parse(text);
    if(data.ok){
      btn.classList.add('saved'); btn.textContent='‚úÖ Grades Saved!'; btn.disabled=false;
      setTimeout(()=>loadAdminData(),1200);
    } else { throw new Error(data.error); }
  } catch(err){
    btn.textContent='‚ùå Error saving ‚Äî retry'; btn.disabled=false; console.error(err);
  }
}

function toggleDetail(id){
  const row=document.getElementById(`subrow-${id}`);
  const det=document.getElementById(`subdetail-${id}`);
  const isOpen=det.classList.contains('open');
  document.querySelectorAll('.submission-detail').forEach(d=>d.classList.remove('open'));
  document.querySelectorAll('.submission-row').forEach(r=>r.classList.remove('open'));
  if(!isOpen){row.classList.add('open');det.classList.add('open');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getQ(id){return questions.find(q=>String(q.id)===String(id));}
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}
function esc(str){
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
